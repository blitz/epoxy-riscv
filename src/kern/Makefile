.PHONY: all
all: epoxy.kern.elf

# You need to set these variables 
APPLICATION_DESC ?= no-such-application.dhall
MACHINE_DESC     ?= no-such-machine.dhall
USER_BINARIES    ?= /does-not-exist
EPOXY_API        ?= /does-not-exist

PREFIX           ?= /usr/local

COMMON_CFLAGS   = -g -flto -I$(EPOXY_API) -MD -Os -fno-common -fomit-frame-pointer -march=rv32ima
COMMON_CXXFLAGS = -std=c++17 -Wall -Wunused-parameter
COMMON_LDFLAGS  = -g -flto -static

KERN_CFLAGS := $(COMMON_CFLAGS) -ffreestanding -nostdinc -fno-exceptions -fno-unwind-tables
KERN_CXXFLAGS := $(COMMON_CXXFLAGS) $(KERN_CFLAGS) -fno-rtti
KERN_LDFLAGS := $(COMMON_LDFLAGS) -nostdlib

# We call it .o, because that makes the file name transformations easier below.
%.kern.o: %.lds
	$(CPP) $(KERN_CFLAGS) -MT $@ -c -o $@ -P -E -x c $<

%.kern.o: %.S
	$(CC) $(KERN_CFLAGS) -c -o $@ $<

%.kern.o: %.cpp
	$(CC) $(KERN_CXXFLAGS) -c -o $@ $<

%.kern.o: %.c
	$(CC) $(KERN_CFLAGS) -c -o $@ $<

# The kernel linking step expects a linker script as first "object".
%.kern.elf:
	$(CC) $(KERN_CFLAGS) $(KERN_LDFLAGS) -o $@ -T $^

KERN_OBJ := $(addsuffix .kern.o, $(addprefix src/, \
                link asm unpaged_entry paged_entry patched process kernel kobject exc_entry \
                scheduler thread state format_backend memset assert format lshrdi3))


# We need to jump through this hoop, because Make is broken in the way
# it handles multiple targets in normal rules. Pattern rules don't
# have this problem.
src/%.cpp include/%.hpp: src/%.dummy $(MACHINE_DESC) $(APPLICATION_DESC)
	epoxy-harden codegen --machine $(MACHINE_DESC) --application $(APPLICATION_DESC) \
                             --out-cpp src/state.cpp \
                             --out-hpp include/state.hpp \
                             --binary-root $(USER_BINARIES)

src/state.dummy:
	touch $@

# This header is autogenerated.
$(KERN_OBJ): include/state.hpp

epoxy.kern.elf: KERN_CXXFLAGS += -Iinclude
epoxy.kern.elf: KERN_CFLAGS += -Iinclude
epoxy.kern.elf: $(KERN_OBJ)

boot.elf: epoxy.kern.elf $(MACHINE_DESC) $(APPLICATION_DESC)
	epoxy-harden boot-image --machine $(MACHINE_DESC) \
                                --application $(APPLICATION_DESC) \
                                --output-format riscv-elf64 \
                                --target-arch riscv-sv32 \
                                --binary-root $(USER_BINARIES) \
                                --kernel $< --output $@

.PHONY: install
install: boot.elf
	mkdir -p $(PREFIX)/bin
	install $< $(PREFIX)/bin/epoxy-boot

-include src/*.d
